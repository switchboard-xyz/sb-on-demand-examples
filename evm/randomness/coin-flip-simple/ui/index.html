<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Switchboard Coin Flip</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-card: #1a1a24;
      --accent: #00ff88;
      --accent-dim: #00cc6a;
      --accent-glow: rgba(0, 255, 136, 0.15);
      --text-primary: #ffffff;
      --text-secondary: #8a8a9a;
      --text-muted: #5a5a6a;
      --border: #2a2a3a;
      --error: #ff4466;
      --warning: #ffaa00;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      background-image:
        radial-gradient(ellipse at 50% 0%, rgba(0, 255, 136, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 20% 80%, rgba(0, 100, 255, 0.05) 0%, transparent 40%);
    }

    .container {
      width: 100%;
      max-width: 420px;
    }

    header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .logo svg {
      width: 32px;
      height: 32px;
    }

    h1 {
      font-size: 1.75rem;
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: 0.9rem;
      font-weight: 400;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 1rem;
    }

    .coin-container {
      display: flex;
      justify-content: center;
      margin-bottom: 2rem;
      perspective: 1000px;
    }

    .coin {
      width: 120px;
      height: 120px;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.1s ease-out;
    }

    .coin.flipping {
      animation: flip 2s ease-in-out;
    }

    .coin.heads {
      transform: rotateY(0deg);
    }

    .coin.tails {
      transform: rotateY(180deg);
    }

    @keyframes flip {
      0% { transform: rotateY(0deg); }
      100% { transform: rotateY(1800deg); }
    }

    .coin-face {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      font-weight: 700;
      backface-visibility: hidden;
      border: 4px solid;
    }

    .coin-heads {
      background: linear-gradient(145deg, #00ff88, #00cc6a);
      border-color: #00aa55;
      color: #003322;
      box-shadow:
        0 8px 32px rgba(0, 255, 136, 0.3),
        inset 0 2px 4px rgba(255, 255, 255, 0.3);
    }

    .coin-tails {
      background: linear-gradient(145deg, #ff4466, #cc3355);
      border-color: #aa2244;
      color: #330011;
      transform: rotateY(180deg);
      box-shadow:
        0 8px 32px rgba(255, 68, 102, 0.3),
        inset 0 2px 4px rgba(255, 255, 255, 0.3);
    }

    .btn {
      width: 100%;
      padding: 1rem 1.5rem;
      border: none;
      border-radius: 12px;
      font-family: 'Outfit', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: var(--accent);
      color: #000;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--accent-dim);
      transform: translateY(-1px);
      box-shadow: 0 4px 20px rgba(0, 255, 136, 0.3);
    }

    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--bg-card);
      border-color: var(--accent);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn .spinner {
      width: 18px;
      height: 18px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .status {
      text-align: center;
      padding: 1rem;
      border-radius: 12px;
      margin-top: 1rem;
      font-size: 0.9rem;
    }

    .status.info {
      background: rgba(0, 255, 136, 0.1);
      color: var(--accent);
      border: 1px solid rgba(0, 255, 136, 0.2);
    }

    .status.error {
      background: rgba(255, 68, 102, 0.1);
      color: var(--error);
      border: 1px solid rgba(255, 68, 102, 0.2);
    }

    .status.warning {
      background: rgba(255, 170, 0, 0.1);
      color: var(--warning);
      border: 1px solid rgba(255, 170, 0, 0.2);
    }

    .result {
      text-align: center;
      padding: 1.5rem;
      border-radius: 12px;
      margin-top: 1rem;
    }

    .result.heads {
      background: rgba(0, 255, 136, 0.1);
      border: 1px solid rgba(0, 255, 136, 0.3);
    }

    .result.tails {
      background: rgba(255, 68, 102, 0.1);
      border: 1px solid rgba(255, 68, 102, 0.3);
    }

    .result-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }

    .result.heads .result-title {
      color: var(--accent);
    }

    .result.tails .result-title {
      color: var(--error);
    }

    .result-subtitle {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .wallet-info {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 0.75rem 1rem;
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .wallet-address {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .wallet-balance {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      color: var(--accent);
    }

    .config-section {
      margin-bottom: 1.5rem;
    }

    .config-section label {
      display: block;
      color: var(--text-secondary);
      font-size: 0.8rem;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .config-section input {
      width: 100%;
      padding: 0.75rem 1rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
    }

    .config-section input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .config-section input::placeholder {
      color: var(--text-muted);
    }

    .rpc-presets {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .preset-btn {
      flex: 1;
      padding: 0.5rem 0.75rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      font-family: 'Outfit', sans-serif;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .preset-btn:hover {
      background: var(--bg-card);
      color: var(--text-primary);
      border-color: var(--accent);
    }

    .preset-btn.active {
      background: var(--accent-glow);
      border-color: var(--accent);
      color: var(--accent);
    }

    .wallet-buttons {
      display: flex;
      gap: 0.75rem;
    }

    .btn-wallet {
      flex: 1;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 0.875rem 1rem;
      font-size: 0.9rem;
    }

    .btn-wallet:hover:not(:disabled) {
      background: var(--bg-card);
      border-color: var(--accent);
    }

    .btn-wallet svg {
      flex-shrink: 0;
    }

    footer {
      text-align: center;
      margin-top: 2rem;
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    footer a {
      color: var(--accent);
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }

    .hidden {
      display: none !important;
    }

    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .step {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--border);
      transition: all 0.3s ease;
    }

    .step.active {
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent);
    }

    .step.completed {
      background: var(--accent-dim);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="16" cy="16" r="14" stroke="currentColor" stroke-width="2" fill="none" style="color: var(--accent)"/>
          <path d="M16 8v16M10 12l6-4 6 4M10 20l6 4 6-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--accent)"/>
        </svg>
        <h1>Coin Flip</h1>
      </div>
      <p class="subtitle">Powered by Switchboard Randomness</p>
    </header>

    <!-- Connect Wallet View -->
    <div id="connect-view" class="card">
      <div class="config-section">
        <label>RPC Endpoint</label>
        <input type="text" id="rpc-url" placeholder="https://..." value="https://testnet-rpc.monad.xyz">
        <div class="rpc-presets">
          <button type="button" class="preset-btn" data-rpc="https://testnet-rpc.monad.xyz">Monad Testnet</button>
          <button type="button" class="preset-btn" data-rpc="https://rpc.monad.xyz">Monad Mainnet</button>
        </div>
      </div>
      <div class="config-section">
        <label>Contract Address</label>
        <input type="text" id="contract-address" placeholder="0x...">
      </div>
      <div class="config-section">
        <label>Select Wallet</label>
        <div class="wallet-buttons">
          <button id="connect-metamask" class="btn btn-wallet">
            <svg width="24" height="24" viewBox="0 0 35 33" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M32.958 1L19.514 11.218l2.482-5.877L32.958 1z" fill="#E17726" stroke="#E17726" stroke-width=".25"/>
              <path d="M2.042 1l13.316 10.313-2.354-5.972L2.042 1zM28.146 23.642l-3.575 5.476 7.65 2.105 2.196-7.456-6.271-.125zM.6 23.767l2.18 7.456 7.634-2.105-3.559-5.476L.6 23.767z" fill="#E27625" stroke="#E27625" stroke-width=".25"/>
              <path d="M10.056 14.558l-2.13 3.218 7.586.346-.253-8.162-5.203 4.598zM24.944 14.558l-5.268-4.693-.172 8.257 7.57-.346-2.13-3.218zM10.414 29.118l4.568-2.232-3.945-3.08-.623 5.312zM20.018 26.886l4.568 2.232-.624-5.312-3.944 3.08z" fill="#E27625" stroke="#E27625" stroke-width=".25"/>
              <path d="M24.586 29.118l-4.568-2.232.369 2.98-.04 1.256 4.239-2.004zM10.414 29.118l4.255 2.004-.024-1.256.352-2.98-4.583 2.232z" fill="#D5BFB2" stroke="#D5BFB2" stroke-width=".25"/>
              <path d="M14.75 21.932l-3.8-1.118 2.685-1.232 1.116 2.35zM20.25 21.932l1.116-2.35 2.7 1.232-3.816 1.118z" fill="#233447" stroke="#233447" stroke-width=".25"/>
              <path d="M10.414 29.118l.655-5.476-4.214.125 3.559 5.351zM23.931 23.642l.655 5.476 3.56-5.351-4.215-.125zM27.074 17.776l-7.57.346.703 3.81 1.116-2.35 2.7 1.232 3.051-3.038zM10.95 20.814l2.685-1.232 1.116 2.35.718-3.81-7.586-.346 3.067 3.038z" fill="#CC6228" stroke="#CC6228" stroke-width=".25"/>
              <path d="M7.883 17.776l3.18 6.199-.108-3.161-3.072-3.038zM24.023 20.814l-.124 3.161 3.18-6.199-3.056 3.038zM15.469 18.122l-.718 3.81.899 4.646.202-6.12-.383-2.336zM19.505 18.122l-.368 2.32.17 6.136.915-4.646-.717-3.81z" fill="#E27525" stroke="#E27525" stroke-width=".25"/>
              <path d="M20.222 21.932l-.915 4.646.655.457 3.944-3.08.124-3.161-3.808 1.138zM10.95 20.814l.108 3.161 3.944 3.08.656-.457-.899-4.646-3.809-1.138z" fill="#F5841F" stroke="#F5841F" stroke-width=".25"/>
              <path d="M20.302 31.122l.04-1.256-.344-.297h-5.012l-.328.297.024 1.256-4.255-2.004 1.488 1.22 3.016 2.088h5.093l3.032-2.088 1.472-1.22-4.226 2.004z" fill="#C0AC9D" stroke="#C0AC9D" stroke-width=".25"/>
              <path d="M20.018 26.886l-.655-.457h-3.742l-.656.457-.352 2.98.328-.297h5.012l.344.297-.28-2.98z" fill="#161616" stroke="#161616" stroke-width=".25"/>
              <path d="M33.517 11.853l1.14-5.502L32.958 1l-12.94 9.602 4.976 4.21 7.03 2.056 1.55-1.81-.675-.488 1.074-.978-.824-.637 1.074-.82-.707-.542zM.343 6.351l1.156 5.502-.738.549 1.074.82-.824.636 1.074.978-.675.489 1.55 1.81 7.03-2.057 4.975-4.21L2.042 1 .343 6.351z" fill="#763E1A" stroke="#763E1A" stroke-width=".25"/>
              <path d="M32.024 16.868l-7.03-2.056 2.13 3.218-3.18 6.199 4.198-.054h6.27l-2.388-7.307zM9.99 14.812l-7.03 2.056-2.36 7.307h6.254l4.198.054-3.18-6.199 2.13-3.218zM19.505 18.122l.449-7.79 2.033-5.5h-9.022l2.033 5.5.449 7.79.17 2.352.016 6.104h3.742l.016-6.104.114-2.352z" fill="#F5841F" stroke="#F5841F" stroke-width=".25"/>
            </svg>
            MetaMask
          </button>
          <button id="connect-phantom" class="btn btn-wallet">
            <svg width="24" height="24" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="64" cy="64" r="64" fill="url(#pg)"/>
              <path d="M110.5 64.9H99.1c0-23.1-19-41.9-42.4-41.9-23.1 0-41.9 18.3-42.4 40.9-.5 23.5 21.5 43.9 45.2 40.9 1.1-.1 1.7-1.4 1.1-2.3-2.6-3.7-4.1-8.1-4.1-12.9 0-12.1 9.6-21.8 21.5-21.8h32.5c1.9 0 3.4-1.6 3.4-3.5 0-2-.5.5-3.4.5z" fill="#fff"/>
              <circle cx="77" cy="52" r="7" fill="#534BB1"/>
              <circle cx="94" cy="52" r="7" fill="#534BB1"/>
              <defs><linearGradient id="pg" x1="64" y1="0" x2="64" y2="128"><stop stop-color="#534BB1"/><stop offset="1" stop-color="#551BF9"/></linearGradient></defs>
            </svg>
            Phantom
          </button>
        </div>
      </div>
      <div id="connect-status" class="status info hidden"></div>
    </div>

    <!-- Game View -->
    <div id="game-view" class="card hidden">
      <div class="wallet-info">
        <span class="wallet-address" id="wallet-address">0x...</span>
        <span class="wallet-balance" id="wallet-balance">0 ETH</span>
      </div>

      <div class="step-indicator">
        <div class="step" id="step-1"></div>
        <div class="step" id="step-2"></div>
        <div class="step" id="step-3"></div>
      </div>

      <div class="coin-container">
        <div class="coin" id="coin">
          <div class="coin-face coin-heads">H</div>
          <div class="coin-face coin-tails">T</div>
        </div>
      </div>

      <button id="flip-btn" class="btn btn-primary">
        Flip the Coin
      </button>

      <button id="settle-btn" class="btn btn-secondary hidden">
        Settle & Reveal
      </button>

      <button id="reset-btn" class="btn btn-secondary hidden">
        Flip Again
      </button>

      <div id="status" class="status info hidden"></div>
      <div id="result" class="result hidden"></div>
    </div>

    <footer>
      Built with <a href="https://switchboard.xyz" target="_blank">Switchboard</a>
    </footer>
  </div>

  <script type="module">
    import { ethers } from 'https://cdn.jsdelivr.net/npm/ethers@6.11.1/+esm';

    const CROSSBAR_URL = 'https://crossbar.switchboard.xyz';
    let chainId = 10143; // Default to Monad Testnet

    const COIN_FLIP_ABI = [
      'function flipCoin() public',
      'function settleFlip(bytes calldata encodedRandomness) public returns (bool isHeads)',
      'function getFlipRandomnessId(address user) public view returns (bytes32)',
      'function getFlipData(address user) public view returns (address oracle, uint256 rollTimestamp, uint256 minSettlementDelay)',
      'function flipRequests(address) public view returns (address user, bytes32 randomnessId, uint256 requestTimestamp)',
      'event CoinFlipRequested(address indexed user, bytes32 randomnessId)',
      'event CoinFlipSettled(address indexed user, bool isHeads, uint256 randomValue)'
    ];

    let provider, signer, contract;

    // DOM Elements
    const connectView = document.getElementById('connect-view');
    const gameView = document.getElementById('game-view');
    const connectMetamaskBtn = document.getElementById('connect-metamask');
    const connectPhantomBtn = document.getElementById('connect-phantom');
    const flipBtn = document.getElementById('flip-btn');
    const settleBtn = document.getElementById('settle-btn');
    const resetBtn = document.getElementById('reset-btn');
    const rpcUrlInput = document.getElementById('rpc-url');
    const contractAddressInput = document.getElementById('contract-address');
    const presetBtns = document.querySelectorAll('.preset-btn');
    const walletAddressEl = document.getElementById('wallet-address');
    const walletBalanceEl = document.getElementById('wallet-balance');
    const statusEl = document.getElementById('status');
    const connectStatusEl = document.getElementById('connect-status');
    const resultEl = document.getElementById('result');
    const coinEl = document.getElementById('coin');

    // Step indicators
    const steps = [
      document.getElementById('step-1'),
      document.getElementById('step-2'),
      document.getElementById('step-3')
    ];

    function updateSteps(current) {
      steps.forEach((step, i) => {
        step.classList.remove('active', 'completed');
        if (i < current) step.classList.add('completed');
        if (i === current) step.classList.add('active');
      });
    }

    function showStatus(message, type = 'info') {
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
      statusEl.classList.remove('hidden');
    }

    function hideStatus() {
      statusEl.classList.add('hidden');
    }

    function showConnectStatus(message, type = 'info') {
      connectStatusEl.textContent = message;
      connectStatusEl.className = `status ${type}`;
      connectStatusEl.classList.remove('hidden');
    }

    function hideConnectStatus() {
      connectStatusEl.classList.add('hidden');
    }

    function showResult(isHeads) {
      resultEl.innerHTML = isHeads
        ? '<div class="result-title">HEADS!</div><div class="result-subtitle">The coin landed on heads</div>'
        : '<div class="result-title">TAILS!</div><div class="result-subtitle">The coin landed on tails</div>';
      resultEl.className = `result ${isHeads ? 'heads' : 'tails'}`;
      resultEl.classList.remove('hidden');

      coinEl.classList.remove('flipping');
      coinEl.classList.add(isHeads ? 'heads' : 'tails');
    }

    function setLoading(btn, loading, text) {
      if (loading) {
        btn.disabled = true;
        btn.innerHTML = `<div class="spinner"></div> ${text}`;
      } else {
        btn.disabled = false;
        btn.textContent = text;
      }
    }

    async function updateBalance() {
      try {
        const address = await signer.getAddress();
        const balance = await provider.getBalance(address);
        walletBalanceEl.textContent = `${parseFloat(ethers.formatEther(balance)).toFixed(4)} ETH`;
      } catch (err) {
        console.warn('Failed to fetch balance:', err.message);
        walletBalanceEl.textContent = '-- ETH';
      }
    }

    async function checkExistingFlip() {
      try {
        const address = await signer.getAddress();
        const request = await contract.flipRequests(address);
        return request.randomnessId !== '0x0000000000000000000000000000000000000000000000000000000000000000';
      } catch (err) {
        console.warn('Failed to check existing flip:', err.message);
        return false;
      }
    }

    // Connect wallet helper
    async function connectWallet(walletProvider, btn, walletName) {
      hideConnectStatus();

      try {
        const rpcUrl = rpcUrlInput.value.trim();
        const contractAddress = contractAddressInput.value.trim();

        if (!rpcUrl) {
          showConnectStatus('Please enter an RPC endpoint', 'error');
          return;
        }

        if (!contractAddress || !ethers.isAddress(contractAddress)) {
          showConnectStatus('Invalid contract address', 'error');
          return;
        }

        if (!walletProvider) {
          throw new Error(`${walletName} is not installed`);
        }

        setLoading(btn, true, 'Connecting...');

        // Get chain ID from the RPC
        const rpcProvider = new ethers.JsonRpcProvider(rpcUrl);
        const rpcNetwork = await rpcProvider.getNetwork();
        chainId = Number(rpcNetwork.chainId);

        // Switch wallet network
        const currentChainId = await walletProvider.request({ method: 'eth_chainId' });
        const currentChainIdNum = parseInt(currentChainId, 16);

        if (currentChainIdNum !== chainId) {
          try {
            await walletProvider.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: '0x' + chainId.toString(16) }],
            });
            await new Promise(resolve => setTimeout(resolve, 500));
          } catch (switchError) {
            if (switchError.code === 4902 || switchError.message?.includes('Unrecognized chain')) {
              try {
                await walletProvider.request({
                  method: 'wallet_addEthereumChain',
                  params: [{
                    chainId: '0x' + chainId.toString(16),
                    chainName: chainId === 143 ? 'Monad' : 'Monad Testnet',
                    nativeCurrency: { name: 'MON', symbol: 'MON', decimals: 18 },
                    rpcUrls: [rpcUrl],
                    blockExplorerUrls: [chainId === 143 ? 'https://explorer.monad.xyz' : 'https://testnet.monadexplorer.com']
                  }]
                });
                await new Promise(resolve => setTimeout(resolve, 500));
              } catch (addError) {
                throw new Error(`Failed to add network: ${addError.message}`);
              }
            } else {
              throw new Error(`Please switch your wallet to chain ID ${chainId}`);
            }
          }
        }

        const browserProvider = new ethers.BrowserProvider(walletProvider);
        await browserProvider.send('eth_requestAccounts', []);
        signer = await browserProvider.getSigner();
        const address = await signer.getAddress();

        provider = browserProvider;
        contract = new ethers.Contract(contractAddress, COIN_FLIP_ABI, signer);

        walletAddressEl.textContent = `${address.slice(0, 6)}...${address.slice(-4)}`;

        hideConnectStatus();
        connectView.classList.add('hidden');
        gameView.classList.remove('hidden');

        updateBalance();

        // Check for existing flip request
        if (await checkExistingFlip()) {
          updateSteps(1);
          flipBtn.classList.add('hidden');
          settleBtn.classList.remove('hidden');
          showStatus('You have a pending flip. Click to settle.', 'warning');
        } else {
          updateSteps(0);
        }

      } catch (err) {
        console.error('Connection error:', err);
        showConnectStatus(err.message, 'error');
      } finally {
        setLoading(btn, false, walletName);
      }
    }

    // RPC preset buttons
    presetBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const rpc = btn.dataset.rpc;
        rpcUrlInput.value = rpc;
        presetBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      });
    });

    // Set initial active state
    presetBtns.forEach(btn => {
      if (btn.dataset.rpc === rpcUrlInput.value) {
        btn.classList.add('active');
      }
    });

    // MetaMask connect
    connectMetamaskBtn.addEventListener('click', () => {
      connectWallet(window.ethereum, connectMetamaskBtn, 'MetaMask');
    });

    // Phantom connect
    connectPhantomBtn.addEventListener('click', () => {
      const phantomProvider = window.phantom?.ethereum;
      connectWallet(phantomProvider, connectPhantomBtn, 'Phantom');
    });

    // Flip the coin
    flipBtn.addEventListener('click', async () => {
      try {
        hideStatus();
        resultEl.classList.add('hidden');
        coinEl.classList.remove('heads', 'tails');
        setLoading(flipBtn, true, 'Flipping...');
        updateSteps(0);

        const tx = await contract.flipCoin();
        showStatus('Transaction sent. Waiting for confirmation...', 'info');
        await tx.wait();

        await updateBalance();
        updateSteps(1);
        showStatus('Coin flipped! Click to settle and reveal.', 'info');

        flipBtn.classList.add('hidden');
        settleBtn.classList.remove('hidden');

      } catch (err) {
        showStatus(err.reason || err.message, 'error');
        setLoading(flipBtn, false, 'Flip the Coin');
      }
    });

    // Settle the flip
    settleBtn.addEventListener('click', async () => {
      try {
        setLoading(settleBtn, true, 'Resolving...');
        updateSteps(1);

        const address = await signer.getAddress();

        const request = await contract.flipRequests(address);

        if (request.randomnessId === '0x0000000000000000000000000000000000000000000000000000000000000000') {
          throw new Error('No pending flip found');
        }

        const randomnessId = request.randomnessId;
        const flipData = await contract.getFlipData(address);

        if (flipData.oracle === '0x0000000000000000000000000000000000000000') {
          throw new Error('No oracle assigned yet');
        }

        showStatus('Fetching randomness from Switchboard...', 'info');

        const crossbarResponse = await fetch(`${CROSSBAR_URL}/randomness/evm`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chain_id: chainId.toString(),
            randomness_id: randomnessId,
            timestamp: Number(flipData.rollTimestamp),
            min_staleness_seconds: Number(flipData.minSettlementDelay),
            oracle: flipData.oracle.toLowerCase()
          })
        });

        if (!crossbarResponse.ok) {
          const errorText = await crossbarResponse.text();
          throw new Error(`Crossbar error: ${errorText}`);
        }

        const crossbarData = await crossbarResponse.json();
        const encoded = crossbarData.data?.encoded || crossbarData.encoded;

        if (!encoded) {
          throw new Error('No encoded randomness in response');
        }

        updateSteps(2);
        showStatus('Settling on-chain...', 'info');

        coinEl.classList.add('flipping');

        const tx = await contract.settleFlip(encoded);
        const receipt = await tx.wait();
        await updateBalance();

        // Parse the CoinFlipSettled event
        let isHeads = false;
        for (const log of receipt.logs) {
          try {
            const parsed = contract.interface.parseLog(log);
            if (parsed?.name === 'CoinFlipSettled') {
              isHeads = parsed.args.isHeads;
              break;
            }
          } catch {}
        }

        setTimeout(() => {
          hideStatus();
          showResult(isHeads);
          settleBtn.classList.add('hidden');
          resetBtn.classList.remove('hidden');
        }, 2000);

      } catch (err) {
        showStatus(err.reason || err.message, 'error');
        coinEl.classList.remove('flipping');
        setLoading(settleBtn, false, 'Settle & Reveal');
      }
    });

    // Reset game
    resetBtn.addEventListener('click', async () => {
      hideStatus();
      resultEl.classList.add('hidden');
      coinEl.classList.remove('heads', 'tails', 'flipping');
      resetBtn.classList.add('hidden');
      settleBtn.classList.add('hidden');
      flipBtn.classList.remove('hidden');
      setLoading(flipBtn, false, 'Flip the Coin');
      updateSteps(0);
      await updateBalance();
    });
  </script>
</body>
</html>
